!function(e){var o={};function t(n){if(o[n])return o[n].exports;var s=o[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,t),s.l=!0,s.exports}t.m=e,t.c=o,t.d=function(e,o,n){t.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,o){if(1&o&&(e=t(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var s in e)t.d(n,s,function(o){return e[o]}.bind(null,s));return n},t.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(o,"a",o),o},t.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},t.p="",t(t.s=1)}([function(e,o){e.exports=require("mongoose")},function(e,o,t){"use strict";var n=this&&this.__awaiter||function(e,o,t,n){return new(t||(t=Promise))(function(s,r){function i(e){try{a(n.next(e))}catch(e){r(e)}}function l(e){try{a(n.throw(e))}catch(e){r(e)}}function a(e){e.done?s(e.value):new t(function(o){o(e.value)}).then(i,l)}a((n=n.apply(e,o||[])).next())})};Object.defineProperty(o,"__esModule",{value:!0});const s=t(2),r=t(0),i=t(3),l=t(4),a=t(5),u=t(6),d=t(7),c=t(8),m=t(9),f=t(10),g=t(11),p=t(12),h=t(13),y=t(14),v=t(15),x=t(16),S=t(17),b=t(18);var q=t(19);console.log(q);let k=[];k.push({name:"Av1",uri:"data:image/jpeg;base64,"+b.readFileSync("./assets/avatar1.jpeg","base64")}),k.push({name:"Av2",uri:"data:image/jpeg;base64,"+b.readFileSync("./assets/avatar2.jpeg","base64")}),k.push({name:"Av3",uri:"data:image/jpeg;base64,"+b.readFileSync("./assets/avatar3.jpeg","base64")}),k.push({name:"Av4",uri:"data:image/jpeg;base64,"+b.readFileSync("./assets/avatar4.jpeg","base64")}),k.push({name:"Av5",uri:"data:image/jpeg;base64,"+b.readFileSync("./assets/avatar5.jpeg","base64")});let T=[];T.push({name:"group",uri:"data:image/png;base64,"+b.readFileSync("./assets/group.png","base64")}),T.push({name:"noAv",uri:"data:image/jpeg;base64,"+b.readFileSync("./assets/noavatar.jpeg","base64")}),c.config();const O=s();O.use(u()),r.connect("mongodb://localhost:27017/Chat",{useNewUrlParser:!0}).then(()=>console.log(`${process.env.USER} Connected to MongoDB `)).catch(e=>console.log(e)),O.use(a.urlencoded({extended:!1})),O.use(a.json()),O.use(d()),O.use(l()),O.use(i("common")),O.get("/",(e,o)=>{o.json({home:"Key generation route"})}),O.get("**",(e,o)=>{o.json({success:"Hello world from express"})});const w=g.createServer(O),E=m(w);w.listen(process.env.PORT,()=>{console.log(`Express Server on port: ${process.env.PORT}`)});const j=e=>{const{username:o,password:t,passwordc:n}=e;let s={username:"",password:"",passwordc:""};return null==o||""===o?s.username="the username is a required field":(o.length<3||o.length>35)&&(s.username="يجب على الاسم أن يتكون من 3~35 حرف"),null==t||""===t?s.password="the password is a required field":t.length<8||t.length>35?s.password="the password must be 8~35 characters":null!=n&&n!==t&&(s.passwordc="the two passwords must be equal"),null==n?(delete s.passwordc,s.password+s.username===""?{isValid:!0,errors:s}:{isValid:!1,errors:s}):s.password+s.passwordc+s.username===""?{isValid:!0,errors:s}:{isValid:!1,errors:s}};E.on("connection",e=>{console.log(`socket: ${e.id} connected`),e.on("validateRegister",o=>n(this,void 0,void 0,function*(){let{errors:t,isValid:n}=j(o);if(n)try{let n=yield h.default.findOne({username:o.username});return n?(t.passwordc=`${n.username} is used by another user`,void E.to(e.id).emit("status",{status:`${n.username} is used by another user`,errors:t})):void E.to(e.id).emit("validatedInput",o.username)}catch(e){return void console.log(e)}else E.to(e.id).emit("status",{status:`${e.id}'s reg-form is invalid`,errors:t}),console.log({authRefused:`${e.id}'s reg-form is invalid`,errors:t})})),e.on("register",o=>n(this,void 0,void 0,function*(){let{password:t,username:n,publicKey:s}=o;try{let o=yield p.genSalt(10),r=yield p.hash(t,o);const i=new h.default({username:n,password:r,publicKey:s,avatar:T[yield T.findIndex(e=>"noAv"===e.name)]});yield i.save(),E.to(e.id).emit("registered")}catch(e){return void console.log(e)}})),e.on("loginRequest",o=>n(this,void 0,void 0,function*(){let{username:t,password:n}=o;console.log(`${t} is trying to login`);const{isValid:s,errors:r}=j(o);if(s)try{let o=yield h.default.findOne({username:t});if(!o)return r.password="The user doesn't exist",console.log("the user doesn't exist"),void E.to(e.id).emit("status",{status:"The user doesn't exist",errors:r});if(!(yield p.compare(n,o.password)))return r.password="The password is invalid",void E.to(e.id).emit("status",{status:"The password is Invalid",errors:r});{let t=yield x.randomBytes(32).toString("hex"),n=yield new y.default({token:t,user:o._id});o.session=n._id;let s=yield n.save(),r=yield o.save();E.to(e.id).emit("token",{token:s.token,publicKey:r.publicKey,avatar:r.avatar,username:r.username})}}catch(e){console.log(e)}else E.to(e.id).emit("status",{status:"invalid registeration form",errors:r})})),e.on("assignKey",o=>n(this,void 0,void 0,function*(){console.log("Assigning a new key");let{token:t,username:n,publicKey:s}=o;try{let o=yield y.default.findOne({token:t});if(!o)return void console.log("The Session Doesn't Exist");{let t=yield h.default.findById(o.user);if(!t)return void console.log("The User Doesn't Exist");{t.publicKey=s;let n=yield t.save();E.to(e.id).emit("keyPairAssigned",{token:o.token,username:n.username,avatar:n.avatar})}}}catch(e){console.log(e)}})),e.on("validateToken",o=>n(this,void 0,void 0,function*(){let t=yield y.default.findOne({token:o});if(t){console.log("The Session Exists");let o=yield h.default.findById(t.user);if(o){console.log("Token is Valid");let n={token:t.token,avatar:o.avatar,username:o.username,publicKey:o.publicKey};return void E.to(e.id).emit("validToken",n)}console.log("The User Doesn't Exist")}else console.log("TokenValidation:||:The Session Doesn't Exist")})),e.on("getImagesArray",o=>{5===k.length&&y.default.findOne({token:o.token},(o,t)=>{o?console.log(o):null!=t&&h.default.findById(t.user,(o,t)=>{o?console.log(o):null!=t&&E.to(e.id).emit("imagesArray",k)})})}),e.on("saveProfile",o=>{console.log("Received Image data"),y.default.findOne({token:o.token},(t,n)=>{t?console.log(t):null!=n&&h.default.findById(n.user,(t,s)=>{if(t)console.log(t);else if(null!=s){const t={token:n.token,username:s.username,avatar:s.avatar};if(o.avatar===s.avatar)return void E.to(e.id).emit("profileSaved",t);s.avatar=o.avatar,s.save((o,t)=>{if(o)console.log(o);else if(null!==t&&null!==t){const o={token:n.token,username:t.username,avatar:t.avatar};console.log("Saved profile"),E.to(e.id).emit("profileSaved",o)}})}})})}),e.on("createRoom",o=>{y.default.findOne({token:o.token},(t,n)=>{t?console.log(t):null==n?console.log("Failed to fetch Session your token must be invalid"):null===o.name||void 0===o.name||""===o.name?E.to(e.id).emit("groupFormError","اكتب اسم المجموعة"):o.name.length<3||o.name.length>30?E.to(e.id).emit("groupFormError","يجب على الاسم ان يتكون من 3~30 حرف"):v.default.findOne({name:o.name},(t,s)=>{t?console.log(t):s?E.to(e.id).emit("groupFormError","the name is taken"):h.default.findById(n.user,["rooms","username"],(t,n)=>{if(t)console.log(t);else if(null!=n){new v.default({leader:n.username,name:o.name,users:[n._id],chat:[]}).save((o,t)=>{o?console.log(o):(f.isEmpty(n.rooms)?n.rooms=[t._id]:n.rooms.push(t._id),n.save((o,n)=>{o?console.log(o):(console.log("Saved User & Room",n),e.join(t.name),E.to(e.id).emit("roomCreated",t))}))})}else console.log("The User doesn't Exist")})})})}),e.on("getRooms",o=>{console.log(o),y.default.findOne({token:o},(o,t)=>{o?console.log(o):null!=t?h.default.findById(t.user,["rooms","username"]).then(o=>{o.populate("rooms",(o,t)=>{t.rooms.forEach((o,t)=>{console.log(o),e.join(o.name),console.log("Joined",o.name)}),E.to(e.id).emit("rooms",t.rooms)})}).catch(e=>console.log(e)):console.log("The Session Doesn't Exists")})}),e.on("logout",o=>{console.log(`${o.username} is logging out`),y.default.findOne({token:o.token},(o,t)=>{o?console.log(o):null!=t?(t.remove(),console.log("The Session is Removed"),E.to(e.id).emit("logedout")):console.log("The Session Doesn't Exist")})}),e.on("newMsg",e=>{const{msg:o,token:t,roomName:n}=e;y.default.findOne({token:t},(e,t)=>{e?console.log(e):null==t?console.log("the token is expired"):h.default.findById(t.user).then(e=>{null!=e?v.default.findOne({name:n}).populate("users",["publicKey","username"]).then(t=>{if(null!=t){let n=x.randomBytes(8).toString("hex"),s=x.randomBytes(32).toString("hex"),r=S.AES.encrypt(o,s,{iv:n,mode:S.mode.CBC,padding:S.pad.Pkcs7}).toString();console.log("cipher-text",r);let i=[],l=Buffer.from(s),a=e.username,u=[];t.users.forEach((o,s)=>{let a=x.publicEncrypt({key:o.publicKey,padding:q.RSA_PKCS1_PADDING},l).toString("base64");i.push({roomName:t.name,from:e.username,msg:r,key:a,publicKey:o.publicKey,iv:n}),u.push({publicKey:o.publicKey,key:a,username:o.username})}),null===t.chat||void 0===t.chat||0===t.chat.length?t.chat=[{from:a,to:u,msg:r,isImage:!1,iv:n}]:t.chat.push({from:a,to:u,msg:r,isImg:!1,iv:n}),t.save().then(e=>{console.log("Saved Room",e.name),console.log(i),E.to(e.name).emit("Msg",i)}).catch(e=>console.log(e))}else console.log("the room doesn't exist")}).catch(e=>console.log(e)):console.log("The User Doesn't Exist")}).catch(e=>console.log(e))})}),e.on("invite",o=>{const{room:t,user:n,username:s}=o;null==n||""===n?E.to(e.id).emit("groupFormError","اكتب اسم الشحص"):n.length<3||n.length>30?E.to(e.id).emit("groupFormError","يجب على الاسم أن يتكون من 3~35 حرف"):h.default.findOne({username:n},(o,n)=>{o?console.log(o):null==n?E.to(e.id).emit("groupFormError","لا يوجد هذا الشخص"):v.default.findOne({name:t},(o,t)=>{if(o)console.log(o);else if(null==t)console.log("The Room doesn't Exist");else if(t.leader===s)if(-1===n.rooms.indexOf(t._id)){-1===n.requests.findIndex(e=>e.roomName===t.name)?(n.requests.push({roomName:t.name,leader:t.leader}),n.save((o,s)=>{o?console.log(o):(E.to(e.id).emit("invited"),console.log(`Invited ${n.username} ==room==> ${t.name} `))})):E.to(e.id).emit("groupFormError","انتظر الشخص لكي يستجيب لدعوتك")}else E.to(e.id).emit("groupFormError","هذا الشخص عضو في المجموعة");else console.log("you have to be the leader of the room to invite")})})}),e.on("getRequests",o=>{y.default.findOne({token:o}).then(o=>{null!=o?h.default.findById(o.user).then(o=>null==o?void console.log("The User is unavailable"):(E.to(e.id).emit("userRequests",o.requests),void console.log(`Sent userRequests to ${o.username}`,o.requests))):console.log("The Session is Expired")}).catch(e=>console.log(e))}),e.on("acceptUserRequest",o=>{let{token:t,roomName:n}=o;y.default.findOne({token:t}).then(o=>{null!=o?h.default.findById(o.user).then(o=>{null!=o?v.default.findOne({name:n}).then(t=>{if(null==t)console.log("The Room is unavailable");else{let s=o.rooms.indexOf(t._id);if(console.log("refIndex",s),-1===s){t.users.push(o._id),o.rooms.push(t._id);let s=o.requests.findIndex(e=>e.roomName===n);o.requests.splice(s,1),t.save().then(t=>{o.save().then(o=>{console.log(`${o.username} joined ${t.name}`),e.join(t.name),E.to(e.id).emit("invitationAccepted",t.name)}).catch(e=>console.log(e))}).catch(e=>console.log(e))}else console.log("you are a member of this group")}}).catch(e=>console.log(e)):console.log("The User is unavailable")}):console.log("The Session is Expired")}).catch(e=>console.log(e))}),e.on("refuseUserRequest",o=>n(this,void 0,void 0,function*(){let{token:t,roomName:n}=o;try{let o=yield y.default.findOne({token:t});if(null==o)return void console.log("The Session Doesn't Exist");{let t=yield h.default.findById(o.user);if(null==t)return void console.log("The User Doesn't Exist");{let o=yield t.requests.findIndex(e=>e.roomName===n);yield t.requests.splice(o,1);let s=yield t.save();console.log("A User Invitation Has Been Deleted",s.requests),E.to(e.id).emit("deletedUserRequest",n)}}}catch(e){console.log(e)}})),e.on("refuseRoomRequest",o=>n(this,void 0,void 0,function*(){let{token:t,roomName:n,person:s}=o;try{let o=yield y.default.findOne({token:t});if(null==o)return void console.log("The Session Doesn't Exist");{let t=yield h.default.findById(o.user);if(null==t)return void console.log("The User Doesn't Exist");{let o=yield v.default.findOne({name:n});if(!o)return void console.log("The room doesn't exist");{let t=o.requests.indexOf(s);if(-1===t)return void console.log("The Request Doesn't exist");yield o.requests.splice(t,1),yield o.save(),E.to(e.id).emit("roomRequestAccepted",{person:s,roomName:n})}}}}catch(e){console.log(e)}})),e.on("joinRequest",o=>n(this,void 0,void 0,function*(){const{token:t,name:n}=o;if(null==n||""===n)E.to(e.id).emit("groupFormError","اكتب اسم المجموعة");else if(n.length<3||n.length>35)E.to(e.id).emit("groupFormError","يجب على اسم المجموعة أن تتكون من 3~35 حرف");else try{let o=yield y.default.findOne({token:t});if(null==o)return void console.log("The Session is Expired");{let t=yield h.default.findById(o.user);if(null==t)return void console.log("The User doesn't exist");{let o=yield v.default.findOne({name:n});if(null==o)return console.log("The Room doesn't exist"),void E.to(e.id).emit("groupFormError","لا توجد هذه مجموعة");{let n=yield o.requests.indexOf(t.username);if(-1!==(yield o.users.indexOf(t._id)))E.to(e.id).emit("groupFormError","أنت عضو في هذه المجموعة");else if(-1===n){yield o.requests.push(t.username);let n=yield o.save();console.log(`${t.username} ==Requests==> ${n.leader} to join ${n.name}`),E.to(e.id).emit("requestSent")}else console.log("The Request already exists"),E.to(e.id).emit("groupFormError","انتظر الرد على طلب الدخول")}}}}catch(e){console.log(e)}})),e.on("acceptRoomRequest",o=>n(this,void 0,void 0,function*(){let{token:t,roomName:n,person:s}=o;try{let o=yield y.default.findOne({token:t});if(!o)return void console.log("The Session Doesn't Exist");if(!(yield h.default.findById(o.user)))return void console.log("The User Doesn't Exist");{let o=yield h.default.findOne({username:s});if(!o)return void console.log("The Person you want to invite doesn't exist");{let t=yield v.default.findOne({name:n});if(!t)return void console.log("The Room Doesn't Exist");if(-1!==(yield t.users.indexOf(o._id)))return void console.log(`${o.username} already exists in ${t.name}`);{yield t.users.push(o._id);let n=yield t.requests.indexOf(o.username);-1!==n?yield t.requests.splice(n,1):console.log("The Request Doesn't Exist");let s=yield t.save();yield o.rooms.push(s._id),o.save(),console.log(`${s.leader} accepted ${o.username}'s request to join ${t.name}`),E.to(e.id).emit("roomRequestAccepted",{person:o.username,roomName:s.name,id:o._id})}}}}catch(e){console.log(e)}})),e.on("disconnect",o=>{console.log(`${e.id} disconnected!!`),console.log("reason",o)})})},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("morgan")},function(e,o){e.exports=require("compression")},function(e,o){e.exports=require("body-parser")},function(e,o){e.exports=require("helmet")},function(e,o){e.exports=require("cors")},function(e,o){e.exports=require("dotenv")},function(e,o){e.exports=require("socket.io")},function(e,o){e.exports=require("lodash")},function(e,o){e.exports=require("http")},function(e,o){e.exports=require("bcryptjs")},function(e,o,t){"use strict";t.r(o);var n=t(0),s=t.n(n);const r=new s.a.Schema({username:{type:String,required:!0,unique:!0,minlength:3,maxlength:35},password:{type:String,required:!0},publicKey:{type:String,required:!0,unique:!0},session:{type:s.a.Schema.Types.ObjectId,ref:"Session",required:!1},avatar:{},rooms:{type:[{type:s.a.Schema.Types.ObjectId,ref:"Room"}],default:[]},requests:{type:[{roomName:String,leader:String}],default:[]},createdAt:{type:Date,default:Date.now}});o.default=s.a.model("User",r)},function(e,o,t){"use strict";t.r(o);var n=t(0),s=t.n(n);const r=new s.a.Schema({createdAt:{type:Date,default:Date.now,expires:"1d"},token:{type:String,unique:!0},user:{type:s.a.Schema.Types.ObjectId,ref:"User"}});o.default=s.a.model("Session",r)},function(e,o,t){"use strict";t.r(o);var n=t(0),s=t.n(n);const r=new s.a.Schema({createdAt:{type:Date,default:Date.now},name:{type:String,unique:!0,required:!0,minlength:3,maxlength:35},requests:{type:[String],default:[]},users:[{type:s.a.Schema.Types.ObjectId,ref:"User"}],leader:String,chat:{type:[{iv:String,msg:String,from:String,to:[{publicKey:String,username:String,key:String}],isImg:Boolean,createdAt:{type:Date,default:Date.now}}],default:[]}});o.default=s.a.model("Room",r)},function(e,o){e.exports=require("crypto")},function(e,o){e.exports=require("crypto-js")},function(e,o){e.exports=require("fs")},function(e,o){e.exports=require("constants")}]);
//# sourceMappingURL=serverBundle.js.map